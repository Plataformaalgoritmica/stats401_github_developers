<!-- Reference: https://github.com/team-centric-software/simple-d3-heatmap -->
<head>
    <meta charset="utf-8">
    <title>D3.js v4 Calendar Heatmap</title>
    <link rel="stylesheet" type="text/css" href="dep/calendar-heatmap.css">

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            crossorigin="anonymous"></script>

    <!-- moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- d3 -->
    <!-- <script src="dep/d3.v4.js" charset="utf-8"></script> -->
    <!-- <script src="https://d3js.org/d3.v6.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>

    <!-- https://github.com/team-centric-software/simple-d3-heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/@tcs-open-source/simple-d3-heatmap@latest/simple-d3-heatmap.min.js"></script>
</head>

<body>
<div id="container"></div>

<script type="text/javascript">
    function loadDateFromString(str) {
        // const time = "2008-10-01 13:54:16-07:00";
        const timeParser = d3.utcParse('%Y-%m-%d %H:%M:%S%Z');
        return timeParser(str);
    }

    function dayFromDate(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
    }

    function renderHeatmap(data) {
        const targetYear = 2016;

        var time2count = {}; /// down to seconds
        var date_str2date = {}; /// date string to date object JS fucking converts date to string
        var day2dev_count = {}; /// down to days
        for (const [_, commits] of Object.entries(data)) {
            for (const commit of commits) {
                const date = loadDateFromString(commit);
                if (date != null && date.getFullYear() === targetYear) {
                    if (!(date in time2count)) time2count[date] = 0;
                    time2count[date]++;
                    date_str2date[date] = date;

                    /// count the number of devs per day to calc means
                    let d = new Date(date.getTime());
                    dayFromDate(d);
                    if (!(d in day2dev_count)) day2dev_count[d] = 0;
                    day2dev_count[d]++;
                    date_str2date[d] = d;
                }
            }
        }
        // console.log(time2count);
        // console.log(day2dev_count);

        /// get average # of commits per day
        var chart_data = {};
        for (const [date_str, count] of Object.entries(time2count)) {
            let d = new Date(date_str2date[date_str].getTime());
            dayFromDate(d);
            chart_data[d.getTime()] = count / day2dev_count[d];
        }
        // console.log(chart_data);

        const heatmap = new SimpleD3Heatmap();
        heatmap.yearly("container", chart_data);
    }

    // load data
    $.getJSON('../commits.json', function (data) {
        renderHeatmap(data);
    });
</script>
</body>

<style>
    .d3-calendar-tooltip {
        background-color: white;
        border: 2px solid #111;
        color: black;
        width: max-content;
        padding: 3px 12px;
    }

    .d3-calendar-tooltip::after {
        box-sizing: border-box;
        display: inline;
        font-size: 12px;
        width: 100%;
        line-height: 1;
        color: #111;
        content: "\25BC";
        position: absolute;
        left: 0px;
        top: 24px;
        text-align: center;
    }
</style>
